<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variable Lookup - Census Studio</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }
        header {
            background: linear-gradient(135deg, #1a5276 0%, #2980b9 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        header p { opacity: 0.9; }
        nav {
            background: #2c3e50;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        nav ul {
            list-style: none;
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }
        nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
        }
        nav a:hover { background: rgba(255,255,255,0.1); }
        main {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .dataset-container {
            background: #1a5276;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            color: white;
        }
        .dataset-container label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }
        .dataset-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .dataset-group {
            flex: 1;
            min-width: 150px;
        }
        .dataset-group select {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
        }
        .dataset-status {
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-top: 1rem;
        }
        .search-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .search-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .search-group {
            flex: 1;
            min-width: 200px;
        }
        .search-group.wide { flex: 2; }
        .search-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #1a5276;
        }
        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #2980b9;
        }
        .results-info {
            background: #e8f4f8;
            padding: 0.75rem 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .results-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #1a5276;
            color: white;
            padding: 1rem;
            text-align: left;
        }
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        tr:hover { background: #f8f9fa; }
        .var-code {
            font-family: 'Consolas', monospace;
            background: #e8f4f8;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            color: #1a5276;
            white-space: nowrap;
        }
        .category-badge {
            background: #6c757d;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .copy-btn:hover { background: #218838; }
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        .no-results {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
        }
        footer a { color: #7fb3d5; }
    </style>
</head>
<body>
    <header>
        <h1>ACS Variable Lookup</h1>
        <p>Search and browse American Community Survey variables</p>
    </header>
    
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="getting-started.html">Getting Started</a></li>
            <li><a href="tools.html">Tool Reference</a></li>
            <li><a href="census-guide.html">Census Data Guide</a></li>
            <li><a href="variable-lookup.html">Variable Lookup</a></li>
            <li><a href="tutorials.html">Tutorials</a></li>
        </ul>
    </nav>
    
    <main>
        <div class="dataset-container">
            <div class="dataset-row">
                <div class="dataset-group">
                    <label for="year">Year</label>
                    <select id="year">
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>
                        <option value="2017">2017</option>
                        <option value="2016">2016</option>
                        <option value="2015">2015</option>
                        <option value="2014">2014</option>
                        <option value="2013">2013</option>
                        <option value="2012">2012</option>
                        <option value="2011">2011</option>
                        <option value="2010">2010</option>
                        <option value="2009">2009</option>
                    </select>
                </div>
                <div class="dataset-group">
                    <label for="survey">ACS Version</label>
                    <select id="survey">
                        <option value="acs5">5-Year Estimates</option>
                        <option value="acs1">1-Year Estimates</option>
                    </select>
                </div>
            </div>
            <div class="dataset-status" id="dataset-status">
                Loading dataset...
            </div>
        </div>
        
        <div class="search-container">
            <div class="search-row">
                <div class="search-group wide">
                    <label for="search">Search Variables</label>
                    <input type="text" id="search" placeholder="Enter keywords (e.g., income, poverty, bachelor)">
                </div>
                <div class="search-group">
                    <label for="category">Category</label>
                    <select id="category">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="search-group">
                    <label for="table">Table</label>
                    <select id="table">
                        <option value="">All Tables</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="results-info">
            <span id="results-count">Loading variables...</span>
        </div>
        
        <div class="results-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 120px;">Variable</th>
                        <th style="width: 80px;">Table Code</th>
                        <th style="width: 200px;">Table Name</th>
                        <th>Description</th>
                        <th style="width: 140px;">Category</th>
                        <th style="width: 60px;">Copy</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                    <tr><td colspan="5" class="loading">Loading variables...</td></tr>
                </tbody>
            </table>
        </div>
    </main>
    
    <footer>
        <p>Census Studio for ArcGIS Pro | <a href="index.html">Back to Home</a></p>
        <p style="margin-top: 0.5rem; opacity: 0.7;">Data source: U.S. Census Bureau American Community Survey</p>
    </footer>

    <script>
        // =====================================================================
        // CONFIGURATION
        // =====================================================================
        const CONFIG = {
            mode: 'local',
            localPath: 'lookups/',
            hostedPath: '',
        };
        
        function getLookupUrl(year, survey) {
            const basePath = CONFIG.mode === 'hosted' ? CONFIG.hostedPath : CONFIG.localPath;
            return `${basePath}acs_variable_lookup_${year}_${survey}.json`;
        }
        // =====================================================================
        
        let allVariables = [];
        let categories = [];
        let tables = {};
        
        // Load the lookup JSON file
        async function loadData() {
            const year = document.getElementById('year').value;
            const survey = document.getElementById('survey').value;
            const surveyLabel = survey === 'acs5' ? '5-Year' : '1-Year';
            
            // Reset state
            allVariables = [];
            categories = [];
            tables = {};
            
            // Reset dropdowns
            document.getElementById('category').innerHTML = '<option value="">All Categories</option>';
            document.getElementById('table').innerHTML = '<option value="">All Tables</option>';
            document.getElementById('search').value = '';
            
            // Show loading state
            document.getElementById('dataset-status').textContent = `Loading ${year} ACS ${surveyLabel} Estimates...`;
            document.getElementById('results-body').innerHTML = '<tr><td colspan="5" class="loading">Loading variables...</td></tr>';
            document.getElementById('results-count').textContent = 'Loading variables...';
            
            try {
                const url = getLookupUrl(year, survey);
                console.log('Loading lookup file from:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                categories = data.categories || [];
                tables = data.tables || {};
                
                // Flatten variables into searchable array
                const variablesData = data.variables || {};
                
                for (const tableCode in variablesData) {
                    const tableVars = variablesData[tableCode];
                    let tableLabel = tableCode;
                    let tableCategory = '';
                    
                    for (const cat in tables) {
                        const tableList = tables[cat];
                        const found = tableList.find(t => t.code === tableCode);
                        if (found) {
                            tableLabel = found.label;
                            tableCategory = cat;
                            break;
                        }
                    }
                    
                    tableVars.forEach(v => {
                        allVariables.push({
                            code: v.code,
                            label: v.label,
                            table: tableCode,
                            tableLabel: tableLabel,
                            category: tableCategory
                        });
                    });
                }
                
                // Populate category dropdown
                const categorySelect = document.getElementById('category');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categorySelect.appendChild(option);
                });
                
                // Update status
                document.getElementById('dataset-status').textContent = 
                    `Loaded: ${year} ACS ${surveyLabel} Estimates — ${allVariables.length.toLocaleString()} variables available`;
                
                // Initial display
                filterResults();
                
            } catch (error) {
                console.error('Error loading lookup file:', error);
                
                document.getElementById('dataset-status').textContent = 
                    `Error: Could not load ${year} ACS ${surveyLabel} data`;
                
                document.getElementById('results-body').innerHTML = `
                    <tr><td colspan="5" class="no-results">
                        <strong>Could not load variable data for ${year} ACS ${surveyLabel}.</strong><br><br>
                        This dataset may not be available. Try a different year or ACS version.<br><br>
                        <code>${error.message}</code>
                    </td></tr>`;
                document.getElementById('results-count').textContent = 'Error loading data';
            }
        }
        
        // Update table dropdown based on category
        function updateTables() {
            const category = document.getElementById('category').value;
            const tableSelect = document.getElementById('table');
            
            tableSelect.innerHTML = '<option value="">All Tables</option>';
            
            if (category && tables[category]) {
                tables[category].forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.code;
                    option.textContent = `${t.code} - ${t.label.substring(0, 50)}${t.label.length > 50 ? '...' : ''}`;
                    tableSelect.appendChild(option);
                });
            }
        }
        
        // Filter and display results
        function filterResults() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const category = document.getElementById('category').value;
            const table = document.getElementById('table').value;
            
            let filtered = allVariables;
            
            if (category) {
                filtered = filtered.filter(v => v.category === category);
            }
            
            if (table) {
                filtered = filtered.filter(v => v.table === table);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(v => 
                    v.code.toLowerCase().includes(searchTerm) ||
                    v.label.toLowerCase().includes(searchTerm) ||
                    v.table.toLowerCase().includes(searchTerm)
                );
            }
            
            const displayLimit = 500;
            const limited = filtered.slice(0, displayLimit);
            
            const countText = filtered.length > displayLimit 
                ? `Showing ${displayLimit} of ${filtered.length.toLocaleString()} variables (refine search to see more)`
                : `Showing ${filtered.length.toLocaleString()} variables`;
            document.getElementById('results-count').textContent = countText;
            
            const tbody = document.getElementById('results-body');
            
            if (limited.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-results">No variables found. Try different search terms.</td></tr>';
                return;
            }
            
            tbody.innerHTML = limited.map(v => {
                // Replace !! separators with pipe for readability
                const cleanLabel = v.label.replace(/!!/g, ' | ');
                return `
                <tr>
                    <td><span class="var-code">${v.code}</span></td>
                    <td>${v.table}</td>
                    <td>${v.tableLabel}</td>
                    <td>${cleanLabel}</td>
                    <td><span class="category-badge">${v.category || 'Other'}</span></td>
                    <td><button class="copy-btn" onclick="copyCode('${v.code}')">Copy</button></td>
                </tr>
            `;
            }).join('');
        }
        
        // Copy variable code to clipboard
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                event.target.textContent = '✓';
                setTimeout(() => { event.target.textContent = 'Copy'; }, 1000);
            });
        }
        
        // Event listeners
        document.getElementById('search').addEventListener('input', filterResults);
        document.getElementById('category').addEventListener('change', () => {
            updateTables();
            filterResults();
        });
        document.getElementById('table').addEventListener('change', filterResults);
        
        // Dataset selectors - reload data when changed
        document.getElementById('year').addEventListener('change', loadData);
        document.getElementById('survey').addEventListener('change', loadData);
        
        // Load data on page load
        loadData();
    </script>
</body>
</html>
